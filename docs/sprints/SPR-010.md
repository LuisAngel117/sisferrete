# SPR-010 — Variantes/atributos + barcode por variante
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Catálogo (variantes), POS scan-ready

---

## 1) Objetivo
Agregar soporte de variantes por producto (por ejemplo: medida, color, calibre, voltaje) con:
- Atributos flexibles (JSON) para no romper el modelo cada vez.
- Barcode por variante (para scan POS).
- Lookup por barcode que encuentre variante y su producto padre.
- UI mínima en español para crear/editar variantes.

**Regla cerrada**
- Un producto puede venderse:
  - sin variantes (se vende el producto base), o
  - con variantes (se vende variante; el producto base queda como contenedor).
- Barcode de variante, si existe, debe ser único por tenant.

---

## 2) Alcance

### 2.1 INCLUYE
**DB**
- Tabla `product_variants` (tenant-scoped) con:
  - `product_id` fk
  - `name` (ej “Rojo 1/2” o “110V 500W”)
  - `barcode` (nullable, unique per tenant)
  - `attributes` jsonb (nullable)
  - `is_active`
- Índices:
  - `(tenant_id, barcode)` unique where barcode not null
  - `(tenant_id, product_id)`

**Backend API**
Requiere `CATALOG_MANAGE`:
- `GET /api/admin/products/{productId}/variants`
- `POST /api/admin/products/{productId}/variants`
- `PUT /api/admin/variants/{variantId}`

Lookup (para POS scan):
- `GET /api/admin/products/lookup?term=...`
  - Debe incluir match por barcode de variante además de barcode del producto.

**Frontend**
- En pantalla producto:
  - tab “Variantes”
  - listar/crear/editar variantes
  - editar atributos básicos con key/value simple (sin editor complejo)

### 2.2 EXCLUYE
- Stock por variante (se implementa con inventario después).
- Precios por variante (luego en pricing).

---

## 3) Entregables

### 3.1 Migración DB
- `V__product_variants.sql`

Campos mínimos:
- `id uuid pk`
- `tenant_id uuid not null`
- `product_id uuid not null fk products(id)`
- `name text not null`
- `barcode text null`
- `attributes jsonb null`
- `is_active boolean not null default true`
- `created_at timestamptz not null default now()`
- `updated_at timestamptz not null default now()`

Constraints:
- unique tenant+barcode where barcode not null

### 3.2 Backend
- Controllers/services/repos para variantes
- Ajuste del lookup para incluir variante
- DTOs claros

### 3.3 Smoke (recomendado)
- `scripts/smoke/sprint10.ps1`
  - crea producto + variante con barcode
  - lookup por barcode de variante
  - imprime el id de variante encontrado

---

## 4) Contratos API (cerrados)
**POST /api/admin/products/{productId}/variants**
Request:
- `name` (string)
- `barcode` (string, opcional)
- `attributes` (object, opcional)
- `isActive` (boolean, default true)

Response:
- `id`, `productId`, `name`, `barcode`, `attributes`, `isActive`

**GET /api/admin/products/lookup?term=...**
Response incluye:
- `matchType`: `PRODUCT_BARCODE | PRODUCT_SKU | PRODUCT_NAME | VARIANT_BARCODE`
- `productId`, `productName`
- `variantId` (si aplica)
- `variantName` (si aplica)
- `uomId`, `uomCode` (si ya está disponible)

---

## 5) Criterios de aceptación (AC)
- [ ] Migración aplica sin error.
- [ ] CRUD variantes funciona y requiere `CATALOG_MANAGE`.
- [ ] Barcode variante único por tenant.
- [ ] Lookup encuentra por barcode de variante.
- [ ] UI permite operar variantes.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 6) Smoke test manual (usuario)
### Pasos
1) Backend arriba.
2) Crear producto.
3) Crear variante con barcode.
4) Lookup por barcode y verificar que retorna variantId.

### Evidencia (LOG.md)
- curl/script outputs

---

## 7) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
