# SPR-011 — Presentaciones/Empaques + conversiones por producto/variante + barcode por empaque
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Catálogo (empaques), POS-scan ready

---

## 1) Objetivo
Soportar la realidad ferretera de vender **por unidad y por empaque**, con conversiones por producto/variante:

- Definir “presentaciones” por producto (y opcionalmente por variante).
- Ejemplo: 1 CAJA = 100 UNIDAD para tornillos.
- Barcode por presentación (para escaneo en POS).
- Integrar lookup para que encuentre:
  - barcode de producto
  - barcode de variante
  - barcode de empaque/presentación

**Decisión cerrada**
- La unidad base del producto es `products.uom_id` (ya existe).
- Las presentaciones son “unidad de venta” alternativa + factor hacia la base.
- Decimales se validan por UoM:
  - UoM con `allows_decimals=false` => cantidades enteras en esa UoM.
  - UoM con `allows_decimals=true` => cantidades decimales permitidas.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
**DB**
- Tabla `product_packagings` (tenant-scoped) con:
  - referencia a `product_id` y opcional `variant_id`
  - `sale_uom_id` (ej: CAJA, PAQUETE)
  - `base_uom_id` (normalmente = product.uom_id; se guarda explícito para integridad)
  - `base_units_per_sale_unit` (numeric) factor: cuántas unidades base hay en 1 unidad de venta
  - `barcode` opcional (unique per tenant)
  - `is_default_for_sale` (boolean) para definir presentación por defecto en POS
  - `is_active`

**Reglas DB**
- Unicidad:
  - `(tenant_id, barcode)` unique where barcode is not null
  - `(tenant_id, product_id, variant_id, sale_uom_id)` unique (evitar duplicados)
- Restricciones:
  - `base_units_per_sale_unit > 0`
  - Si `variant_id` no es null, debe pertenecer al mismo product_id.

**Backend (Admin API)**
Protección por permiso:
- Reutiliza `CATALOG_MANAGE`

Rutas cerradas:
- `GET /api/admin/products/{productId}/packagings`
- `POST /api/admin/products/{productId}/packagings`
- `PUT /api/admin/packagings/{packagingId}`

Lookup (extensión del lookup existente):
- `GET /api/admin/products/lookup?term=...`
  - Debe buscar también por `product_packagings.barcode`

**Frontend (mínimo, ES)**
- En producto (o variante):
  - Tab “Presentaciones”
  - Listar/crear/editar presentaciones:
    - UoM de venta
    - factor
    - barcode
    - default
    - activo

**Smoke (recomendado)**
- `scripts/smoke/sprint11.ps1`:
  1) login admin
  2) crear producto base UNIDAD
  3) crear presentación CAJA factor 100 y barcode “PACK-...”
  4) lookup por barcode del pack y verificar `matchType=PACKAGING_BARCODE`

### 2.2 EXCLUYE (Scope = No)
- Precios por presentación (va en SPR-012 con pricing items por uom).
- Stock por presentación (se deriva de base; inventario vendrá luego).
- POS (módulo ventas) todavía no.

---

## 3) Entregables

### 3.1 Migración DB
Crear migración nueva (ajustar número real):
- `backend/src/main/resources/db/migration/V__product_packagings.sql`

Campos mínimos:
- `id uuid pk`
- `tenant_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `sale_uom_id uuid not null`
- `base_uom_id uuid not null`
- `base_units_per_sale_unit numeric(18,6) not null`
- `barcode text null`
- `is_default_for_sale boolean not null default false`
- `is_active boolean not null default true`
- `created_at timestamptz not null default now()`
- `updated_at timestamptz not null default now()`

Índices/constraints:
- unique tenant+barcode where barcode not null
- unique tenant+product+variant+sale_uom
- check base_units_per_sale_unit > 0

### 3.2 Backend
Paquete sugerido:
- `com.sisferrete.catalog.packaging.*`
  - `AdminPackagingController`
  - `PackagingService/Repository`
  - DTOs
- Ajustar lookup:
  - agregar `PACKAGING_BARCODE` como `matchType`

### 3.3 Frontend
- En `/admin/productos/:id` (o modal):
  - Tab Presentaciones

---

## 4) Contratos API (cerrados)

### 4.1 POST /api/admin/products/{productId}/packagings
Request:
- `variantId` (uuid, opcional)
- `saleUomId` (uuid, requerido)
- `baseUomId` (uuid, requerido; normalmente el uom del producto)
- `baseUnitsPerSaleUnit` (number, requerido)
- `barcode` (string, opcional)
- `isDefaultForSale` (boolean, default false)
- `isActive` (boolean, default true)

Response:
- `id`, `productId`, `variantId`, `saleUomId`, `baseUomId`, `baseUnitsPerSaleUnit`, `barcode`, `isDefaultForSale`, `isActive`

### 4.2 GET lookup
Response debe poder incluir:
- `matchType`: agrega `PACKAGING_BARCODE`
- `productId`, `productName`
- `variantId/variantName` si aplica
- `packagingId` si aplica
- `saleUomId/saleUomCode` si aplica
- `baseUnitsPerSaleUnit` si aplica

---

## 5) Criterios de aceptación (AC)
- [ ] Migración aplica sin error.
- [ ] CRUD de presentaciones funciona y requiere `CATALOG_MANAGE`.
- [ ] Unicidad barcode por tenant.
- [ ] Lookup encuentra por barcode de presentación y retorna `PACKAGING_BARCODE`.
- [ ] UI en español permite operar presentaciones.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 6) Smoke test manual (usuario)
### Pasos
1) Backend arriba.
2) Crear producto + presentación.
3) Lookup por barcode del pack.

### Evidencia (LOG.md)
- output del script (si existe) o curl requests/responses

---

## 7) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
