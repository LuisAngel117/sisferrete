# SPR-006 — Configuración crítica (IVA) + permisos protegidos + auditoría
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Seguridad/Config (sin features de negocio)

---

## 1) Objetivo (qué se logra)
Implementar configuración crítica por tenant (IVA) **ultra protegida**, auditable y lista para UI Admin:

- Persistir y leer `tenant_config` (o equivalente).
- Endpoint(s) admin para ver/editar IVA.
- Protección por permisos granulares.
- Auditoría de cambios (before/after).
- Validación de rango y formato.

**Decisión cerrada (para no adivinar)**
- IVA se representará como **basis points** (bps) entero para precisión:
  - 1200 = 12.00%
  - 1500 = 15.00%
- UI muestra porcentaje con 2 decimales.
- DB: `vat_rate_bps` (int) en `tenant_config`.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
**DB**
- Asegurar columna `vat_rate_bps int not null` en `tenant_config`.
- Default recomendado: 1500 (pero editable).
- Auditoría: registrar before/after.

**Backend**
- Permiso nuevo (código exacto):
  - `CONFIG_VAT_EDIT`
- (Opcional pero recomendado)
  - `CONFIG_VIEW`
- Endpoints:
  - `GET /api/admin/tenant-config`
  - `PUT /api/admin/tenant-config/vat`
- Autorización:
  - Solo usuarios con `CONFIG_VAT_EDIT` pueden cambiar IVA.
- Validaciones:
  - `vatRateBps` entero en rango [0..2500] (0% a 25.00%).
- Auditoría:
  - Al cambiar IVA: `CONFIG_VAT_CHANGED` (before/after + actor)

**Frontend (mínimo)**
- Pantalla Admin simple:
  - Ver IVA actual
  - Editar IVA (input) con confirmación
  - Mensajes en español

### 2.2 EXCLUYE (Scope = No)
- Configuración fiscal SRI (va más adelante).
- Secuencias de documentos.
- Configuración avanzada (otros parámetros).

---

## 3) Entregables

### 3.1 Migración DB
Archivo nuevo (ajustar número según orden real):
- `backend/src/main/resources/db/migration/V__tenant_config_vat_bps.sql`
Debe:
- Crear `tenant_config` si no existe (solo si de verdad no existe; si ya existe, no recrear).
- Agregar `vat_rate_bps` con `ADD COLUMN IF NOT EXISTS`.
- Establecer default si procede.

### 3.2 Backend
Paquete sugerido:
- `com.sisferrete.platform.config.*`
  - `TenantConfigController`
  - `TenantConfigService`
  - `TenantConfigRepository` (JdbcTemplate/JPA)
  - DTOs request/response

Seguridad:
- `@RequirePermission("CONFIG_VAT_EDIT")` (o mecanismo equivalente) para PUT.

Auditoría:
- Reusar `AuditService` (SPR-005) para registrar:
  - actionCode: `CONFIG_VAT_CHANGED`

### 3.3 Frontend
- Ruta: `/admin/configuracion` (o similar)
- UI en español.

---

## 4) Instrucciones de implementación (cerradas)

### 4.1 Permission codes (sin discusión)
- Asegurar que existe permission code:
  - `CONFIG_VAT_EDIT`
- Si ya existe con otro nombre:
  - NO borrar el viejo.
  - Insertar el nuevo.
  - Crear RFC “normalización de permisos” para migrar más adelante.

### 4.2 Contratos API (cerrados)
**GET /api/admin/tenant-config**
Response:
- `tenantId`
- `vatRateBps`
- `vatRatePercent` (string con 2 decimales, ej "15.00")

**PUT /api/admin/tenant-config/vat**
Request:
- `{ "vatRateBps": 1500 }`

Responses:
- 200 con config actualizada.
- 400 si invalidación de rango/formato.
- 403 si no tiene permiso.

### 4.3 Auditoría obligatoria
En PUT exitoso, registrar:
- actionCode: `CONFIG_VAT_CHANGED`
- before_state: `{ "vatRateBps": ... }`
- after_state: `{ "vatRateBps": ... }`
- metadata: `{ "reason": "..." }` (opcional; si no hay UI para razón, dejar null)

### 4.4 Trazabilidad
- STATUS: SPR-006 -> READY_FOR_VALIDATION
- LOG: comandos + placeholders para outputs
- CHANGELOG: `[Unreleased]` + “Tenant config IVA protegido”.

---

## 5) Criterios de aceptación (AC)
- [ ] `GET /api/admin/tenant-config` funciona con auth.
- [ ] `PUT /api/admin/tenant-config/vat`:
  - valida rango
  - requiere `CONFIG_VAT_EDIT`
  - actualiza DB
  - registra auditoría `CONFIG_VAT_CHANGED`
- [ ] Frontend muestra IVA y permite editar (mínimo).
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 6) Smoke test manual (usuario)
### Pasos
1) Backend arriba.
2) Con token de admin/superadmin:
   - GET config
   - PUT IVA a 1500
   - GET config
3) Query auditoría:
   - `select action_code, created_at from audit_events order by created_at desc limit 10;`

### Evidencia (pegar en LOG.md)
- curl requests + responses (o script)
- query auditoría

---

## 7) DoD
- AC completos.
- Estado = READY_FOR_VALIDATION.

<!-- EOF -->
