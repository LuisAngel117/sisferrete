# SPR-003 — DB + migraciones base (tenants/branches/users/roles/permissions) + seed demo
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Infra/DB (base), sin features de negocio

---

## 1) Objetivo (qué se logra)
Dejar PostgreSQL local listo con:
- Migraciones (Flyway) funcionando.
- Esquema base multi-tenant:
  - `tenants`, `branches`
  - `users`, `roles`, `permissions`, mapeos
  - `tenant_config` (IVA editable protegido)
  - `audit_events` (base auditoría)
- Seed demo mínimo:
  - Tenant: “Ferreteria”
  - Sucursal: “Matriz” (o código base)
  - Roles base: `SUPERADMIN`, `ADMIN`, `CAJERO`
  - Permisos base (los del doc de seguridad)

**Importante**
- Sin inventar credenciales inseguras.
- Si se crea usuario demo, debe tener password hash generado correctamente (no plaintext).

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
- Configurar Flyway en backend.
- Crear migraciones SQL para tablas base (mínimas del “platform layer”).
- Crear seeding seguro (preferible vía código al startup si evita hardcode de hash; permitido en este sprint).
- Ajustar configuración local (DB URL/usuario/password por env o application-local.yml).

### 2.2 EXCLUYE (Scope = No)
- Tablas de catálogo/stock/ventas (van en sprints posteriores).
- Auth/JWT endpoints (SPR-004).
- Docker.

---

## 3) Pre-check (obligatorio para Codex)
1) `git status` limpio
2) `git config user.name` y `git config user.email` presentes
3) Rama actual

---

## 4) Entregables

### 4.1 Migraciones Flyway
En `backend/src/main/resources/db/migration/`:
- `V1__platform_base.sql` (tablas base)
- `V2__platform_seed.sql` (seed mínimo) **o** seeding por código (ApplicationRunner) + migración solo schema.

### 4.2 Config DB local
- Variables/config local sin Docker.
- Runbook mínimo en LOG de cómo correr migraciones.

---

## 5) Instrucciones de implementación (cerradas)

### 5.1 Flyway
1) Agregar dependencia Flyway (si no está).
2) Configurar Flyway para ejecutar al arrancar.
3) Configurar datasource Postgres local:
- NO hardcodear credenciales reales en git.
- Permitir `.env` o variables de entorno (si aún no existe, documentar en README o LOG).

### 5.2 Esquema mínimo (V1__platform_base.sql)
Crear tablas (mínimo):
- `tenants`
- `branches`
- `users`
- `roles`
- `permissions`
- `role_permissions`
- `user_roles` (incluye `scope_branch_id` nullable)
- `user_branch_access` (opcional pero recomendado)
- `tenant_config` (incluye `vat_rate`)
- `audit_events`

Requisitos:
- Primary keys UUID.
- Foreign keys consistentes.
- Índices:
  - `users(tenant_id, email)`
  - `roles(tenant_id, code)`
  - `branches(tenant_id, code)`
  - `audit_events(tenant_id, created_at)`

### 5.3 Seed mínimo
Debe crear:
- Tenant name = “Ferreteria”
- Branch “Matriz” con `code` estable (ej: `MATRIZ`)
- Roles: `SUPERADMIN`, `ADMIN`, `CAJERO`
- Permisos: insertar permisos recomendados en `docs/05-SEGURIDAD.md` (códigos estables)

Sobre usuario demo:
- Si se crea `SUPERADMIN` demo, debe:
  - email configurable por env (default permitido solo en local)
  - password configurable por env
  - password almacenada hasheada (BCrypt u otro seguro)
- Si esto complica el sprint, crear RFC y dejar seed sin usuario (pero roles/permisos sí).

### 5.4 Trazabilidad
- LOG: append indicando SPR-003, qué migraciones se agregaron y cómo aplicar.
- STATUS: SPR-003 en READY_FOR_VALIDATION.
- CHANGELOG: registrar “DB platform base + Flyway”.

---

## 6) Criterios de aceptación (AC)
- [ ] Al arrancar backend con Postgres local disponible:
  - Flyway aplica migraciones sin error.
- [ ] Tablas base existen.
- [ ] Seed mínimo crea tenant, branch, roles y permisos.
- [ ] No hay credenciales en texto plano commiteadas.
- [ ] LOG y STATUS actualizados (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 7) Smoke test manual (usuario)
### Pasos
1) Levantar Postgres local (instalado) y crear DB (si aplica).
2) Exportar variables (ejemplo; ajustar a tu entorno):
   - `SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/sisferrete`
   - `SPRING_DATASOURCE_USERNAME=postgres`
   - `SPRING_DATASOURCE_PASSWORD=<tu_password>`
3) Backend:
   - `cd backend`
   - `./mvnw spring-boot:run`
4) Verificar en logs que Flyway aplicó V1/V2 sin fallar.

### Evidencia a pegar
- Logs de arranque donde se vea Flyway aplicado.
- (Opcional) Query simple en psql mostrando que existen tablas.

---

## 8) “Comandos verdad”
- `cd backend && ./mvnw spring-boot:run`

---

## 9) DoD
- AC completos.
- Estado queda **READY_FOR_VALIDATION** hasta que el usuario pegue outputs.

---

## 10) Huecos/contradicciones
- No editar sprint.
- RFC/ADR + CHANGELOG.

<!-- EOF -->
