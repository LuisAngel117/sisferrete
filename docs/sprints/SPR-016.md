# SPR-016 — Compras directas: proveedores + compras + recepciones parciales + posting a inventario + costo promedio ponderado
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Compras/Inventario/Costos (foundation)

---

## 1) Objetivo
Implementar compras directas (sin orden previa) con recepción parcial y posting a inventario, además de actualizar costo promedio ponderado:

- CRUD Proveedores.
- Crear compra (header + líneas) en DRAFT.
- Registrar recepciones parciales (múltiples).
- Al postear una recepción:
  - incrementa stock en bodega destino
  - registra ledger `PURCHASE_RECEIVED`
  - recalcula costo promedio ponderado por producto/variante (cost basis)
- Auditoría completa de eventos.

**Decisiones cerradas**
- Compras son directas (no PO obligatoria).
- Recepción parcial: sí.
- Costeo global: Promedio ponderado (AVG).
- Moneda: USD. Redondeo a centavos para totales; costo promedio puede guardarse con 6 decimales.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)

**Permisos (códigos exactos)**
- `SUPPLIER_MANAGE`
- `PURCHASE_CREATE`
- `PURCHASE_APPROVE` (si decides separar; si no, igual se define y se usa para POST)
- `PURCHASE_RECEIVE` (post de recepción)
- `COST_EDIT` ya existe (pero compras debe actualizar costo sin requerir COST_EDIT)

Asignación mínima (idempotente):
- `ADMIN`: SUPPLIER_MANAGE + PURCHASE_CREATE + PURCHASE_RECEIVE (+ PURCHASE_APPROVE si aplica)
- `COMPRAS` (si existe): SUPPLIER_MANAGE + PURCHASE_CREATE + PURCHASE_RECEIVE (sin APPROVE si se decide)
- `SUPERADMIN`: todos

**DB**
- `suppliers`
- `purchases` (header)
- `purchase_lines`
- `purchase_receipts`
- `purchase_receipt_lines`
- `inventory_movements` reusar
- `inventory_stocks` reusar
- `product_cost_basis` (ya existe) extender si hace falta:
  - permitir que compras actualice `cost_per_base_unit` promedio ponderado

**Backend**
- CRUD Proveedores
- CRUD Compras + líneas (DRAFT)
- Workflow:
  - submit (opcional si quieres) y post de recepción
- Servicio transaccional de posting:
  - aplica stock + ledger
  - recalcula costo promedio ponderado
  - registra auditoría

**Frontend (mínimo, ES)**
- Compras → Proveedores (listar/crear/editar)
- Compras → Nueva compra (proveedor, factura_ref opcional, bodega destino, líneas)
- Compras → Recepciones (registrar parcial y postear)

**Smoke (obligatorio recomendado)**
- `scripts/smoke/sprint16.ps1`:
  1) login admin
  2) crear proveedor
  3) crear compra con línea (producto/variante + qty + unit_cost)
  4) crear receipt parcial y postear
  5) verificar:
     - stock incrementó
     - ledger insertado
     - cost basis actualizado (query endpoint o DB)
  6) postear segunda recepción (resto) y verificar promedio ponderado correcto

### 2.2 EXCLUYE (Scope = No)
- Cuentas por pagar completa (pagos, vencimientos, conciliación) → sprints posteriores.
- Retenciones/SRI, documentos fiscales.
- Importación masiva.

---

## 3) Modelo de datos (cerrado)

### 3.1 suppliers
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `code text not null` (uppercase snake)
- `name text not null`
- `tax_id text null` (RUC/CI opcional por ahora)
- `phone text null`
- `email text null`
- `address text null`
- `is_active boolean not null default true`
- timestamps

Unique:
- `(tenant_id, code)`

### 3.2 purchases (header)
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `branch_id uuid not null`
- `warehouse_id uuid not null` (destino)
- `supplier_id uuid not null`
- `status text not null` (DRAFT | SUBMITTED | PARTIALLY_RECEIVED | RECEIVED | CANCELED)
- `supplier_invoice_ref text null` (opcional)
- `note text null`
- `created_by_user_id uuid null`
- timestamps

### 3.3 purchase_lines
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `purchase_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `base_uom_id uuid not null`
- `quantity_base numeric(18,6) not null`
- `unit_cost_per_base_unit numeric(18,6) not null`
- `discount_amount numeric(18,2) not null default 0`
- `tax_amount numeric(18,2) not null default 0` (por ahora 0; IVA módulo final)
- `line_total numeric(18,2) not null` (calculado)

Rules:
- check `quantity_base > 0`
- check `unit_cost_per_base_unit > 0`

### 3.4 purchase_receipts (header)
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `purchase_id uuid not null`
- `status text not null` (DRAFT | POSTED)
- `received_by_user_id uuid null`
- `received_at timestamptz null`
- `note text null`

### 3.5 purchase_receipt_lines
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `receipt_id uuid not null`
- `purchase_line_id uuid not null`
- `quantity_received_base numeric(18,6) not null`

Rule:
- sum(received) por línea <= quantity_base

---

## 4) Posting (cerrado) — Recepción de compra
Acción: `POST /api/purchases/receipts/{receiptId}/post`

1) Validar receipt DRAFT y purchase en DRAFT/SUBMITTED/PARTIALLY_RECEIVED.
2) Validar cantidades pendientes (no exceder).
3) Aplicar stock destino:
   - UPSERT `inventory_stocks` por product/variant en warehouse destino, incrementando `quantity_base`.
4) Insertar ledger por línea recibida:
   - `movement_type=PURCHASE_RECEIVED`
   - `reference_type=PURCHASE_RECEIPT`
   - `reference_id=receipt.id`
   - `delta_quantity_base=+qty`
5) Actualizar costo promedio ponderado:
   - Obtener `current_qty` (antes del incremento) y `current_avg_cost` (de `product_cost_basis` si existe; si no, tomar 0).
   - `new_qty = current_qty + received_qty`
   - `new_avg = (current_avg*current_qty + received_unit_cost*received_qty) / new_qty`
   - Guardar en `product_cost_basis.cost_per_base_unit` con 6 decimales.
   - **Para variante**: si `variant_id` existe, mantener cost basis por (product, variant).
6) Actualizar status de purchase:
   - si recibido total: RECEIVED
   - si parcial: PARTIALLY_RECEIVED
7) Auditoría obligatoria:
   - `SUPPLIER_CREATED/UPDATED`
   - `PURCHASE_CREATED`
   - `PURCHASE_RECEIPT_POSTED` (incluye resumen: qty y valor)

---

## 5) API (cerrada)

### 5.1 Proveedores
- `GET /api/admin/suppliers`
- `POST /api/admin/suppliers`
- `PUT /api/admin/suppliers/{id}`

Permiso: `SUPPLIER_MANAGE`

### 5.2 Compras
- `GET /api/purchases?status=...&limit=...`
- `POST /api/purchases` (create header)
- `GET /api/purchases/{id}`
- `POST /api/purchases/{id}/lines`
- `PUT /api/purchase-lines/{lineId}`
- `DELETE /api/purchase-lines/{lineId}` (solo DRAFT)

### 5.3 Recepciones
- `POST /api/purchases/{id}/receipts` (crea receipt DRAFT con líneas)
- `POST /api/purchases/receipts/{receiptId}/post`

Permisos:
- create compra/editar líneas: `PURCHASE_CREATE`
- post receipt: `PURCHASE_RECEIVE`

---

## 6) Migración DB
Crear migración:
- `backend/src/main/resources/db/migration/V__purchases_base.sql`

Debe:
- crear tablas e índices
- insertar permisos y mapear roles base idempotente

---

## 7) Criterios de aceptación (AC)
- [ ] CRUD proveedores funciona con `SUPPLIER_MANAGE`.
- [ ] Se puede crear compra y líneas (DRAFT).
- [ ] Se puede registrar recepción parcial y postear.
- [ ] Posting incrementa stock y crea ledger `PURCHASE_RECEIVED`.
- [ ] Posting recalcula y actualiza `product_cost_basis` (promedio ponderado) correctamente.
- [ ] Status compra pasa a PARTIALLY_RECEIVED / RECEIVED.
- [ ] Auditoría registra eventos clave.
- [ ] UI mínima ES operable.
- [ ] Smoke script sprint16 existe.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 8) Smoke test manual (usuario)
Ejecutar:
- `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint16.ps1`
Evidencia: output completo en LOG.md.

---

## 9) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
