# SPR-007 — Gestión de usuarios/roles/permisos + acceso a sucursales (GATE)
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Seguridad/IAM (GATE)

---

## 1) Objetivo (qué se logra)
Entregar IAM completo y usable (backend + UI mínima) para operar el sistema multi-sucursal sin “atajos”:

- CRUD de usuarios (por tenant).
- Gestión de roles (por tenant) y asignación de permisos.
- Asignación de roles a usuarios.
- Control de acceso a sucursales (branch access).
- Auditoría de acciones sensibles (crear/editar usuario, roles, permisos, branch access).
- Smoke scripts para validar el módulo completo.

**Gate**
Este sprint es GATE: el módulo IAM debe poder validarse completo localmente antes de avanzar.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
**DB**
- Asegurar tablas y constraints para:
  - roles/permisos (si ya existen, solo ajustar incrementalmente)
  - user_roles
  - user_branch_access (o equivalente)
- Índices y unicidad:
  - `users(tenant_id, email)` unique
  - `roles(tenant_id, code)` unique

**Permisos (códigos exactos)**
- `IAM_MANAGE` (gestionar usuarios/roles/permisos)
- `AUDIT_VIEW` (para futuro, pero ya se define)
- `CONFIG_VAT_EDIT` (ya en SPR-006)

**Backend (API Admin)**
Rutas propuestas (cerradas):
- `GET /api/admin/users`
- `POST /api/admin/users`
- `GET /api/admin/users/{userId}`
- `PUT /api/admin/users/{userId}`
- `POST /api/admin/users/{userId}/roles` (replace)
- `POST /api/admin/users/{userId}/branches` (replace)
- `GET /api/admin/roles`
- `POST /api/admin/roles`
- `PUT /api/admin/roles/{roleId}`
- `POST /api/admin/roles/{roleId}/permissions` (replace)
- `GET /api/admin/permissions` (catálogo)

**Seguridad**
- Todas las rutas `/api/admin/**` requieren auth + permiso `IAM_MANAGE`.
- `/api/me` debe reflejar roles/permisos y branchAccess consistentemente.

**Auditoría obligatoria**
Registrar (mínimo):
- `IAM_USER_CREATED`
- `IAM_USER_UPDATED`
- `IAM_USER_ROLES_CHANGED`
- `IAM_USER_BRANCHES_CHANGED`
- `IAM_ROLE_CREATED`
- `IAM_ROLE_UPDATED`
- `IAM_ROLE_PERMISSIONS_CHANGED`

**Frontend (mínimo usable)**
- Sección Admin en español:
  - Usuarios: listar + crear + editar + asignar roles + acceso sucursales (UI simple).
  - Roles: listar + crear/editar + asignar permisos (UI simple).
- No se exige diseño final perfecto aquí, pero sí que sea operable.

**Smoke**
- `scripts/smoke/sprint7.ps1` que:
  1) login como superadmin/admin
  2) crea un usuario cajero
  3) asigna rol CAJERO
  4) asigna acceso a branch “Matriz”
  5) login como cajero y llama `/api/me` para verificar permisos/scopes

### 2.2 EXCLUYE (Scope = No)
- Gestión avanzada (invitar por email, recuperación password, etc.) si no está ya definido.
- Multi-empresa (multi-tenant ya está, pero “multi-empresa SaaS” a nivel de hosting no aplica aquí).

---

## 3) Entregables

### 3.1 Migración DB (si aplica)
Nuevo archivo incremental si hace falta:
- `V__iam_constraints_and_branch_access.sql`
Debe:
- crear `user_branch_access` si no existe
- constraints/indices

### 3.2 Backend
Paquetes sugeridos:
- `com.sisferrete.platform.iam.*`
  - `AdminUsersController`, `AdminRolesController`, `AdminPermissionsController`
  - services + repositories
  - DTOs (requests/responses)
- Seguridad:
  - `RequirePermission("IAM_MANAGE")` para admin endpoints

### 3.3 Frontend
- `/admin/usuarios`
- `/admin/roles`

### 3.4 Scripts
- `scripts/smoke/sprint7.ps1`

---

## 4) Contratos API (cerrados)

### 4.1 Users
**POST /api/admin/users**
Request:
- `email` (string)
- `fullName` (string)
- `password` (string) (solo creación; hash en backend)
- `isActive` (boolean)

Response:
- `userId`, `email`, `fullName`, `isActive`

**PUT /api/admin/users/{userId}**
- permite actualizar `fullName`, `isActive`
- NO permite cambiar email sin RFC (por simplicidad y estabilidad)

**POST /api/admin/users/{userId}/roles** (replace)
Request:
- `{ "roleCodes": ["CAJERO"] }`

**POST /api/admin/users/{userId}/branches** (replace)
Request:
- `{ "branchIds": ["...uuid..."] }`
o si se maneja “all branches”:
- `{ "allBranches": true }`

### 4.2 Roles
**POST /api/admin/roles**
Request:
- `code` (string uppercase snake: ADMIN, CAJERO, etc.)
- `name` (string ES visible)
- `description` (string)

**POST /api/admin/roles/{roleId}/permissions** (replace)
Request:
- `{ "permissionCodes": ["IAM_MANAGE", "CONFIG_VAT_EDIT"] }`

### 4.3 Permissions
**GET /api/admin/permissions**
Response:
- lista con `code`, `name`, `description`, `module`

---

## 5) Instrucciones de implementación (cerradas)

### 5.1 Seed/roles base
Asegurar roles base (si ya existen, NO duplicar):
- `SUPERADMIN`
- `ADMIN`
- `CAJERO`

Asegurar permissions base (si no existen, insertar):
- `IAM_MANAGE`
- `AUDIT_VIEW`
- `CONFIG_VAT_EDIT`

### 5.2 Autorización
- `/api/admin/**` => requiere `IAM_MANAGE`
- Todos los cambios admin generan auditoría (obligatorio).

### 5.3 Auditoría
En cada operación admin, registrar actionCode correspondiente con:
- before_state / after_state (mínimo para cambios)
- metadata con ids relevantes

### 5.4 Trazabilidad
- STATUS: SPR-007 -> READY_FOR_VALIDATION (Gate)
- LOG: comandos exactos + placeholders para outputs
- CHANGELOG: `[Unreleased]` + “IAM admin usable + branch access”.

---

## 6) Criterios de aceptación (AC) — Gate
- [ ] Como admin/superadmin:
  - crear usuario
  - asignar roles
  - asignar acceso a sucursal
- [ ] Como usuario nuevo:
  - login
  - `/api/me` refleja roles/permisos/branchAccess coherente
- [ ] Admin endpoints protegidos por `IAM_MANAGE`
- [ ] Auditoría registra eventos IAM_*
- [ ] Frontend mínimo operable (admin usuarios/roles)
- [ ] `scripts/smoke/sprint7.ps1` produce evidencia validable
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION, sin DONE/APROBADO)

---

## 7) Smoke test manual (usuario) — Gate
### Pasos
1) Backend arriba.
2) Ejecutar:
   - `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint7.ps1`
3) Revisar en DB auditoría:
   - `select action_code, created_at from audit_events order by created_at desc limit 20;`

### Evidencia (pegar en LOG.md)
- Output completo de sprint7.ps1
- Query auditoría

---

## 8) DoD
- AC completos.
- Estado = READY_FOR_VALIDATION (hasta evidencias reales).

<!-- EOF -->
