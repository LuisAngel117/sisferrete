# SPR-013 — Inventario base: bodegas (por sucursal), ubicaciones, stock ledger + lecturas
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Inventario (foundation)

---

## 1) Objetivo
Crear la base sólida de inventario (multi-tenant + multi-sucursal) lista para que POS/E-commerce y compras se integren después:

- Bodegas por sucursal (branch) y ubicaciones internas (pasillo/estante).
- Stock por bodega para producto/variante (en unidad base).
- Ledger de movimientos (solo estructura + lectura, no operaciones complejas aún).
- Endpoints admin/operativos para leer:
  - bodegas/ubicaciones
  - existencias actuales
  - historial de movimientos (ledger)

**Decisiones cerradas**
- SaaS-ready: todas las tablas llevan `tenant_id`.
- Multi-sucursal: bodegas dependen de `branch_id`.
- Stock se guarda en **unidad base** del producto/variante (la UoM del producto).
- Cantidades:
  - se guardan como `numeric(18,6)` por compatibilidad con decimales
  - validación de “decimales sí/no” se aplica según la UoM base (`allows_decimals`)
- NO se permite inventario negativo (en SPR-014 se aplica la regla en posting; aquí se prepara estructura).

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)

**Permisos (códigos exactos)**
- `INVENTORY_VIEW`
- `INVENTORY_MANAGE`

Asignación mínima por rol (idempotente):
- `ADMIN`: VIEW + MANAGE
- `BODEGUERO` (si existe): VIEW + MANAGE (si aún no existe rol, RFC)
- `SUPERADMIN`: todos

**DB**
Crear tablas (tenant-scoped):
1) `warehouses`
2) `warehouse_locations`
3) `inventory_stocks`
4) `inventory_movements` (ledger básico)

**Backend**
- CRUD mínimo para bodegas/ubicaciones (admin):
  - list/create/update/activate
- Lecturas de stock (por bodega + búsqueda por producto/variante)
- Lecturas del ledger de movimientos (filtrable por fecha + producto)

**Frontend (mínimo, ES)**
- Admin → Inventario:
  - Bodegas (listar/crear/editar/activar)
  - Ubicaciones (por bodega)
  - Stock (vista simple por bodega con búsqueda)

**Smoke (recomendado)**
- `scripts/smoke/sprint13.ps1`:
  - login admin
  - crear bodega en la sucursal actual
  - crear ubicación “PASILLO-1/ESTANTE-A”
  - listar bodegas/ubicaciones
  - listar stock (vacío/0 al inicio)

> Nota: en este sprint el stock puede ser 0; no se exigen movimientos aún.

### 2.2 EXCLUYE (Scope = No)
- Ajustes con aprobación y posting (SPR-014).
- Transferencias entre sucursales (posterior).
- Recepciones de compra (posterior).
- Reserva de stock e-commerce (posterior).

---

## 3) Dependencias/Precondiciones (si falta, RFC)
- Debe existir entidad de sucursal/branch (`branch_id`) y mecanismo de scoping (ej: header `X-Branch-Id`).
- Deben existir productos/variantes (SPR-009/SPR-010).

Si cualquiera no existe o no está claro:
- Crear RFC y **detener** si bloquea implementación.

---

## 4) Modelo de datos (cerrado)

### 4.1 warehouses
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `branch_id uuid not null`
- `code text not null` (uppercase snake, ej: BODEGA_PRINCIPAL)
- `name text not null` (ES)
- `is_active boolean not null default true`
- timestamps

Constraints:
- unique `(tenant_id, branch_id, code)`

### 4.2 warehouse_locations
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `warehouse_id uuid not null`
- `code text not null` (ej: PASILLO_1_ESTANTE_A)
- `name text not null` (ES visible, ej: “Pasillo 1 / Estante A”)
- `is_active boolean not null default true`
- timestamps

Constraints:
- unique `(tenant_id, warehouse_id, code)`

### 4.3 inventory_stocks
Representa existencia actual (snapshot) por bodega.

Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `branch_id uuid not null`
- `warehouse_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `base_uom_id uuid not null`
- `quantity_base numeric(18,6) not null default 0`
- timestamps

Constraints:
- unique `(tenant_id, warehouse_id, product_id, variant_id)`
- check `quantity_base >= 0` (en DB)

### 4.4 inventory_movements (ledger)
Este ledger se “append-only” cuando se postean operaciones (SPR-014).

Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `branch_id uuid not null`
- `warehouse_id uuid not null`
- `movement_type text not null`
  - valores permitidos (por ahora): `ADJUSTMENT_POSTED`
- `reference_type text not null` (ej: INVENTORY_ADJUSTMENT)
- `reference_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `base_uom_id uuid not null`
- `delta_quantity_base numeric(18,6) not null` (puede ser + o -)
- `note text null`
- `created_at timestamptz not null default now()`

Índices:
- `(tenant_id, warehouse_id, created_at desc)`
- `(tenant_id, product_id, created_at desc)`

---

## 5) API (cerrada)

### 5.1 Scoping
- Endpoints de inventario requieren tenant scope + branch scope.
- Para branch scope usar:
  - Header `X-Branch-Id` obligatorio en endpoints que dependan de sucursal.
- Validar que el usuario tiene acceso a la sucursal (branch access, SPR-007).

### 5.2 Permisos
- Lecturas: `INVENTORY_VIEW`
- CRUD bodegas/ubicaciones: `INVENTORY_MANAGE`

### 5.3 Endpoints (cerrados)

**Bodegas**
- `GET /api/admin/inventory/warehouses` (requiere X-Branch-Id)
- `POST /api/admin/inventory/warehouses` (requiere X-Branch-Id)
- `PUT /api/admin/inventory/warehouses/{id}`

**Ubicaciones**
- `GET /api/admin/inventory/warehouses/{warehouseId}/locations`
- `POST /api/admin/inventory/warehouses/{warehouseId}/locations`
- `PUT /api/admin/inventory/locations/{id}`

**Stock**
- `GET /api/inventory/stocks?warehouseId=...&query=...`
  - `query` busca por nombre/SKU/barcode/variant barcode/packaging barcode reusando lookup existente si se puede.
  - si no se puede integrar ahora, RFC (no inventar).

**Movimientos (ledger)**
- `GET /api/inventory/movements?warehouseId=...&productId=...&from=...&to=...&limit=...`

---

## 6) Migración DB
Crear migración:
- `backend/src/main/resources/db/migration/V__inventory_base.sql`

Debe:
- crear tablas
- crear índices/constraints
- insertar permisos `INVENTORY_VIEW`, `INVENTORY_MANAGE` idempotente
- mapear a roles base idempotente (si roles existen; si no, RFC y crear mapping cuando roles existan)

---

## 7) Criterios de aceptación (AC)
- [ ] Migración aplica sin error.
- [ ] CRUD bodegas/ubicaciones funciona y respeta `X-Branch-Id`.
- [ ] `inventory_stocks` existe con constraints no-negativo.
- [ ] Endpoints de lectura de stock/ledger existen (aunque ledger esté vacío inicialmente).
- [ ] Permisos aplican (403 si no corresponde).
- [ ] UI mínima en español operable para bodegas/ubicaciones y vista stock.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 8) Smoke test manual (usuario)
### Pasos
1) Backend arriba (Postgres local + migraciones).
2) Login admin.
3) Crear bodega y ubicación.
4) Consultar:
   - bodegas
   - ubicaciones
   - stock (debe mostrar 0/empty)

### Evidencia (LOG.md)
- output de script o curl

---

## 9) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
