# SPR-008 — Catálogo base: categorías, marcas, UoM (decimales por unidad)
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Catálogo (base), validable local

---

## 1) Objetivo (qué se logra)
Implementar el **catálogo base** (tenant-scoped) necesario para ferretería y POS:
- Categorías (familias).
- Marcas.
- Unidades de medida (UoM) con regla: **decimales según unidad**.
- Permiso granular de administración de catálogo: `CATALOG_MANAGE`.
- Backend API admin + UI mínima en español para operar estas tablas.

**Decisión cerrada**
- El catálogo es **por tenant** (SaaS-ready): todas las filas llevan `tenant_id`.
- UoM define si permite decimales:
  - UNIDAD/CAJA/PAQUETE: enteros
  - METRO/KILO/LITRO: decimales

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
**DB**
- Tablas:
  - `categories`
  - `brands`
  - `units_of_measure`
- Índices y unicidad por tenant:
  - `categories(tenant_id, code)` unique
  - `brands(tenant_id, code)` unique
  - `units_of_measure(tenant_id, code)` unique

**Permisos**
- Crear permission code: `CATALOG_MANAGE`
- Asegurar asignación al rol `ADMIN` (y `SUPERADMIN` si aplica) mediante migración idempotente.

**Backend (API admin)**
Rutas cerradas (todas requieren `CATALOG_MANAGE`):
- `GET /api/admin/catalog/categories`
- `POST /api/admin/catalog/categories`
- `PUT /api/admin/catalog/categories/{id}`
- `GET /api/admin/catalog/brands`
- `POST /api/admin/catalog/brands`
- `PUT /api/admin/catalog/brands/{id}`
- `GET /api/admin/catalog/uoms`
- `POST /api/admin/catalog/uoms`
- `PUT /api/admin/catalog/uoms/{id}`

**Validaciones**
- `code`: uppercase snake (ej: `HERRAMIENTAS`, `BOSCH`, `UNIDAD`, `METRO`)
- `name`: español, requerido
- `is_active`: boolean

**Frontend (mínimo operable, ES)**
- Sección Admin → Catálogo:
  - Categorías (listar/crear/editar/activar-desactivar)
  - Marcas (listar/crear/editar/activar-desactivar)
  - Unidades (listar/crear/editar; `allowsDecimals` visible)

### 2.2 EXCLUYE (Scope = No)
- Productos (SPR-009)
- Variantes (SPR-010)
- Empaques/conversiones (SPR-011)

---

## 3) Pre-check (Codex)
1) git status limpio
2) git user.name/email presentes
3) rama reportada

---

## 4) Entregables

### 4.1 Migración DB
Crear migración nueva (ajustar numeración real):
- `backend/src/main/resources/db/migration/V__catalog_base.sql`

Debe:
1) Crear tablas si no existen.
2) Insertar UoM base (si no existen):
   - `UNIDAD` allows_decimals=false
   - `CAJA` allows_decimals=false
   - `PAQUETE` allows_decimals=false
   - `METRO` allows_decimals=true
   - `KILOGRAMO` allows_decimals=true
   - `LITRO` allows_decimals=true

> Insert idempotente: `INSERT ... ON CONFLICT DO NOTHING`.

3) Insertar permiso `CATALOG_MANAGE` (si no existe) y mapear a role `ADMIN` (y `SUPERADMIN` si aplica).

### 4.2 Backend
Paquetes sugeridos:
- `com.sisferrete.catalog.*`
  - `AdminCatalogController`
  - services + repositories + DTOs
Seguridad:
- Guard `RequirePermission("CATALOG_MANAGE")` en todos los endpoints admin.

### 4.3 Frontend
- Ruta: `/admin/catalogo` con tabs o subrutas:
  - `/admin/catalogo/categorias`
  - `/admin/catalogo/marcas`
  - `/admin/catalogo/unidades`

---

## 5) Reglas de datos (cerradas)

### 5.1 Esquema mínimo (campos recomendados)
Todas tenant-scoped:
- `id uuid pk`
- `tenant_id uuid not null`
- `code text not null`
- `name text not null`
- `is_active boolean not null default true`
- `created_at timestamptz not null default now()`
- `updated_at timestamptz not null default now()` (si no se usa trigger, actualizar en app)

UoM adicional:
- `allows_decimals boolean not null`

### 5.2 Validación de codes
- `code` debe ser uppercase snake `[A-Z0-9_]+`
- Rechazar si no cumple (400)

---

## 6) Criterios de aceptación (AC)
- [ ] Migración aplica sin error.
- [ ] Endpoints admin funcionan y requieren `CATALOG_MANAGE`.
- [ ] UI en español permite operar categorías/marcas/unidades.
- [ ] UoM base existe (6 unidades).
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 7) Smoke test manual (usuario)
### Pasos
1) Backend arriba.
2) Login como admin/superadmin.
3) Probar (curl o script):
- listar uoms
- crear categoría
- crear marca
4) Verificar 403 si usuario sin permiso intenta acceder.

### Evidencia (en LOG.md)
- Requests/responses (curl) o output de script

---

## 8) “Comandos verdad”
- `cd backend && ./mvnw spring-boot:run`
- (si hay script) `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint8.ps1` (solo si el sprint lo crea; si no existe, NO inventar)

---

## 9) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
