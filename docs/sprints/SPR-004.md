# SPR-004 — Auth base (email+password, JWT/refresh) + scoping tenant/branch (Gate)
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Seguridad/Plataforma (Gate de validación)

---

## 1) Objetivo (qué se logra)
Implementar autenticación y contexto de ejecución multi-tenant de forma **usable localmente**:
- Login con email+password.
- JWT access token + refresh token.
- Endpoint `/api/me` para ver identidad, tenant y permisos.
- Scoping:
  - Todas las requests autenticadas conocen `tenant_id` del usuario.
  - Para operaciones por sucursal, se define header `X-Branch-Id` (y se valida acceso).

**Gate**
Este sprint es Gate: aquí se valida que “plataforma base” queda realmente operativa.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)
**Backend**
- Spring Security configurado.
- Endpoints:
  - `POST /api/auth/login`
  - `POST /api/auth/refresh`
  - `GET /api/me`
  - `GET /api/secure/ping` (requiere auth; devuelve ok + tenant_id)
- Modelo refresh tokens (tabla o almacenamiento simple seguro).
- Validación de tenant y branch:
  - `X-Branch-Id` obligatorio solo en endpoints que lo requieran (por ahora: `/api/secure/ping` puede NO requerirlo, pero se deja mecanismo listo).
- Scripts smoke:
  - `scripts/smoke/sprint4.ps1` que haga login y llame `/api/me`.

**Frontend**
- Pantalla login conectada a `/api/auth/login`.
- Guardar token en memoria/localStorage (definir y documentar).
- Mostrar pantalla “Sesión iniciada” y el usuario en UI ES.

**2FA TOTP (opcional y configurable)**
- Debe quedar “listo” como contrato y mínimo scaffolding:
  - Si `users.two_factor_enabled=true`, login pide código TOTP.
- Si no entra en 45–90 min, se crea RFC explícito y se deja stub claro (pero NO inventar “ya funciona”).

### 2.2 EXCLUYE (Scope = No)
- Gestión completa de usuarios/roles UI (SPR-007).
- Catálogo, inventario, ventas.
- Docker/online.

---

## 3) Pre-check (obligatorio para Codex)
1) `git status` limpio
2) git user.name/email configurados
3) rama reportada

---

## 4) Entregables

### 4.1 Backend
- Auth funcional: login/refresh/me.
- Scoping tenant correcto.
- Endpoint secure protegido.

### 4.2 Frontend
- Login UI en español conectado.
- Pantalla post-login mínima.

### 4.3 Scripts
- `scripts/smoke/sprint4.ps1`:
  - ejecuta login
  - imprime tamaño de token
  - llama `/api/me`
  - reporta tenant/rol/permisos (si aplica)

---

## 5) Instrucciones de implementación (cerradas)

### 5.1 Contratos de API (cerrados)
**POST /api/auth/login**
- Request JSON:
  - `email` (string)
  - `password` (string)
  - `totp` (string, opcional; solo si 2FA activo)
- Response JSON:
  - `accessToken`
  - `refreshToken`
  - `expiresInSeconds`

Errores:
- 401 si credenciales invalidas
- 401 si 2FA requerido y no provisto o inválido

**POST /api/auth/refresh**
- Request JSON:
  - `refreshToken`
- Response:
  - nuevo `accessToken` + `expiresInSeconds`
- 401 si refresh inválido/expirado

**GET /api/me** (Auth requerido)
- Response:
  - `userId`
  - `email`
  - `fullName`
  - `tenantId`
  - `roles` (lista)
  - `permissions` (lista de codes)
  - `branchAccess` (lista branchIds) o flag “allBranches”

**GET /api/secure/ping** (Auth requerido)
- Response:
  - `{ "ok": true, "tenantId": "...", "userId": "..." }`

### 5.2 Persistencia mínima
- Password hash seguro (BCrypt recomendado).
- Refresh tokens:
  - Tabla `refresh_tokens` con:
    - `id` uuid
    - `tenant_id`
    - `user_id`
    - `token` (string, unique)
    - `expires_at`
    - `revoked_at` nullable
    - `created_at`
- Si no existe en migraciones, agregar migración `V3__auth_tokens.sql`.

### 5.3 Tenant scoping (cerrado)
- El access token debe incluir `tenant_id` y `user_id`.
- En cada request autenticada:
  - el backend resuelve usuario y tenant desde JWT.
- Para branch:
  - se implementa helper para leer `X-Branch-Id` y validar acceso vs `user_branch_access` o roles globales.
  - Aunque pocos endpoints lo usen ahora, el mecanismo queda listo.

### 5.4 Frontend (cerrado)
- Login form con:
  - email
  - password
  - (si backend responde “2FA requerido” o si se decide, mostrar campo TOTP)
- Al éxito:
  - guardar `accessToken` (y refresh si se usa) en localStorage (documentar).
  - mostrar “Sesión iniciada” y email.
- No construir dashboard completo aún.

### 5.5 Trazabilidad
- LOG: append con instrucciones exactas de comandos para validar (usuario).
- STATUS: SPR-004 en READY_FOR_VALIDATION (hasta outputs).
- CHANGELOG: registrar “Auth base + scoping”.

---

## 6) Criterios de aceptación (AC)
- [ ] Existe usuario válido (seed) para login local.
- [ ] `POST /api/auth/login` retorna tokens.
- [ ] `GET /api/me` retorna info coherente (tenant/roles/permisos).
- [ ] `GET /api/secure/ping` requiere auth.
- [ ] Frontend permite iniciar sesión y muestra estado.
- [ ] `scripts/smoke/sprint4.ps1` funciona y genera evidencia pegable.
- [ ] STATUS/LOG actualizados y estado = READY_FOR_VALIDATION.

---

## 7) Smoke test manual (usuario) — Gate
### Pasos
1) Asegurar Postgres local activo y migraciones aplicadas.
2) Backend:
   - `cd backend`
   - `./mvnw spring-boot:run`
3) Ejecutar script:
   - `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint4.ps1`
4) Frontend:
   - `cd frontend`
   - `npm run dev`
5) Probar login en UI.

### Evidencia a pegar
- Output completo de `sprint4.ps1`
- Logs de backend relevantes (login/refresh/me si aparecen)
- Captura textual o descripción corta del login funcionando en UI

---

## 8) “Comandos verdad”
Backend:
- `cd backend && ./mvnw spring-boot:run`

Smoke:
- `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint4.ps1`

Frontend:
- `cd frontend && npm run dev`

---

## 9) DoD
- AC completos.
- Estado: **READY_FOR_VALIDATION** hasta evidencias del usuario.

---

## 10) Huecos/contradicciones
- No editar sprint.
- RFC/ADR + CHANGELOG.
- Si 2FA no entra, RFC obligatorio documentando el ajuste sin decir “ya está”.

<!-- EOF -->
