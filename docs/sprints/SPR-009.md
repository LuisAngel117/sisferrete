# SPR-009 — Productos base (SKU/barcode), búsqueda rápida, estado activo
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Catálogo (productos), POS-ready search

---

## 1) Objetivo
Agregar productos base (tenant-scoped) con búsqueda rápida orientada a POS:
- Producto con nombre, SKU opcional, barcode opcional.
- Relación con categoría, marca, UoM base.
- Búsqueda por:
  - nombre (contains/ilike)
  - SKU exact/like
  - barcode exact
- UI mínima operable en español.

**Regla cerrada**
- SKU y barcode pueden ser nulos, pero **al menos uno debe existir**:
  - o `sku` o `barcode` (o ambos).
- `uom_id` obligatorio.

---

## 2) Alcance

### 2.1 INCLUYE
**DB**
- Tabla `products` (tenant-scoped) con:
  - `name`
  - `sku` (nullable)
  - `barcode` (nullable)
  - `category_id` nullable
  - `brand_id` nullable
  - `uom_id` not null
  - `is_active` boolean
- Índices:
  - `(tenant_id, sku)` unique where sku not null
  - `(tenant_id, barcode)` unique where barcode not null
  - índice para búsqueda por nombre: `(tenant_id, name)` (o trigram si luego, por RFC)

**Permisos**
- Reutiliza `CATALOG_MANAGE` para CRUD.
- (Opcional) `CATALOG_VIEW` si quieres diferenciar lectura; si se introduce, debe ser por migración idempotente.

**Backend API (admin)**
Todas requieren `CATALOG_MANAGE`:
- `GET /api/admin/products?query=...&limit=...`
- `POST /api/admin/products`
- `GET /api/admin/products/{id}`
- `PUT /api/admin/products/{id}`

Búsqueda rápida adicional (para POS; también protegida por ahora):
- `GET /api/admin/products/lookup?term=...`
  - `term` puede ser sku/barcode/nombre parcial

**Frontend**
- `/admin/productos`:
  - listado con búsqueda
  - crear/editar producto
  - selector de UoM, categoría, marca

### 2.2 EXCLUYE
- Variantes (SPR-010)
- Empaques (SPR-011)
- Precios (SPR-012)

---

## 3) Entregables
### 3.1 Migración DB
Crear migración:
- `V__products_base.sql`
Con constraints:
- check: `(sku is not null) OR (barcode is not null)`.

### 3.2 Backend
- `AdminProductsController`
- `ProductService/Repository`
- Validaciones:
  - name requerido
  - uom requerido
  - sku/barcode: al menos uno
  - unicidad por tenant

### 3.3 Smoke script (recomendado)
- `scripts/smoke/sprint9.ps1`:
  - login
  - crear producto
  - buscar por sku/barcode
  - imprimir outputs (sin inventar)

---

## 4) Contratos API (cerrados)
**POST /api/admin/products**
Request:
- `name` (string)
- `sku` (string, opcional)
- `barcode` (string, opcional)
- `categoryId` (uuid, opcional)
- `brandId` (uuid, opcional)
- `uomId` (uuid, requerido)
- `isActive` (boolean, default true)

Response:
- `id`, `name`, `sku`, `barcode`, `uomId`, `categoryId`, `brandId`, `isActive`

**GET /api/admin/products?query=...**
- devuelve lista paginable/simple con `limit` default 50

**GET /api/admin/products/lookup?term=...**
- devuelve top N (default 10) priorizando:
  1) barcode exact
  2) sku exact
  3) nombre contains

---

## 5) Criterios de aceptación (AC)
- [ ] Migración aplica sin error.
- [ ] CRUD productos funciona y requiere `CATALOG_MANAGE`.
- [ ] Validación “sku o barcode” activa (400 si ambos null).
- [ ] Búsqueda lookup funciona (barcode/sku/nombre).
- [ ] UI permite operar productos y buscar rápido.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 6) Smoke test manual (usuario)
### Pasos
1) Backend arriba.
2) Crear categoría/marca/uom (si hace falta).
3) Crear producto con sku y/o barcode.
4) Buscar por sku y por barcode.
5) Confirmar que crear producto sin sku y sin barcode falla (400).

### Evidencia (LOG.md)
- curl/script outputs

---

## 7) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
