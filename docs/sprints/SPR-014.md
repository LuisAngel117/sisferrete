# SPR-014 — Ajustes de inventario con aprobación + posting + regla NO NEGATIVO (GATE)
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Inventario (operación), GATE

---

## 1) Objetivo
Entregar ajustes de inventario (conteos cíclicos/ajustes) con flujo controlado:

- Crear ajuste (cabecera + líneas) en DRAFT.
- Enviar (SUBMITTED).
- Aprobar (APPROVED) por usuario con permiso.
- Postear (POSTED): aplica cambios a `inventory_stocks` y agrega movimientos a `inventory_movements`.
- Regla dura: **NO permitir inventario negativo** en posting (rechazar si provocaría negativo).
- Auditoría completa (before/after) de acciones sensibles.

**Decisiones cerradas**
- Ajustes requieren motivo y aprobación.
- No existe override para negativo: siempre se bloquea.
- Cantidades en líneas se expresan en **unidad base** (y opcionalmente en UoM de venta si UI lo soporta, pero el posting debe convertir a base).
- Redondeo/validación de decimales por UoM base (allows_decimals).

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)

**Permisos (códigos exactos)**
- `INVENTORY_ADJUST_CREATE`
- `INVENTORY_ADJUST_APPROVE`
- Reusa `INVENTORY_VIEW` y `INVENTORY_MANAGE` de SPR-013.

Asignación mínima:
- `ADMIN`: CREATE + APPROVE
- `BODEGUERO`: CREATE (sin approve) (si no existe rol, RFC)
- `SUPERADMIN`: todos

**DB**
- `inventory_adjustments` (header)
- `inventory_adjustment_lines`
- constraints para integridad tenant/branch/warehouse

**Backend**
- Endpoints para:
  - crear ajuste
  - agregar/editar líneas
  - submit
  - approve
  - post (aplicar stock + ledger) — solo si APPROVED
- Servicio transaccional `InventoryPostingService`:
  - aplica deltas
  - valida no-negativo antes de persistir
  - inserta ledger rows
  - registra auditoría

**Frontend (mínimo, ES)**
- Inventario → Ajustes:
  - listar ajustes por bodega (DRAFT/SUBMITTED/APPROVED/POSTED)
  - crear ajuste con motivo
  - agregar líneas (producto/variante + cantidad)
  - enviar, aprobar, postear (según permisos)

**Smoke (obligatorio)**
- `scripts/smoke/sprint14.ps1` que valide el flujo completo:
  1) login admin
  2) crear producto (si no existe uno de prueba, usar uno ya existente; si no hay, RFC)
  3) crear ajuste + línea + aprobar + postear
  4) verificar stock actualizado (query endpoint o query DB con comandos que el usuario pegará)
  5) intentar postear ajuste que deje stock negativo y verificar rechazo (409/400 con error claro)

### 2.2 EXCLUYE (Scope = No)
- Transferencias entre bodegas/sucursales (posterior).
- Recepción de compra (posterior).
- Conteos cíclicos “full workflow” con importación masiva (posterior).

---

## 3) Modelo de datos (cerrado)

### 3.1 inventory_adjustments
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `branch_id uuid not null`
- `warehouse_id uuid not null`
- `status text not null` (DRAFT | SUBMITTED | APPROVED | POSTED | CANCELED)
- `reason text not null` (motivo)
- `created_by_user_id uuid null`
- `approved_by_user_id uuid null`
- `posted_by_user_id uuid null`
- `created_at timestamptz not null default now()`
- `approved_at timestamptz null`
- `posted_at timestamptz null`

### 3.2 inventory_adjustment_lines
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `adjustment_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `base_uom_id uuid not null`
- `delta_quantity_base numeric(18,6) not null` (positivo = aumenta stock, negativo = reduce)
- `note text null`

Constraints:
- unique `(tenant_id, adjustment_id, product_id, variant_id)` (evitar duplicados; si se necesita múltiples líneas por mismo item, RFC)
- check `delta_quantity_base <> 0`

---

## 4) API (cerrada)

### 4.1 Endpoints
Todos requieren `X-Branch-Id` y branch access.

**CRUD básico**
- `GET /api/inventory/adjustments?warehouseId=...&status=...&limit=...`
- `POST /api/inventory/adjustments`
- `GET /api/inventory/adjustments/{id}`
- `POST /api/inventory/adjustments/{id}/lines`
- `PUT /api/inventory/adjustment-lines/{lineId}`
- `DELETE /api/inventory/adjustment-lines/{lineId}` (solo DRAFT)

**Workflow**
- `POST /api/inventory/adjustments/{id}/submit`
- `POST /api/inventory/adjustments/{id}/approve`
- `POST /api/inventory/adjustments/{id}/post`

### 4.2 Permisos por acción
- Crear ajuste / editar líneas (DRAFT): `INVENTORY_ADJUST_CREATE`
- Submit: `INVENTORY_ADJUST_CREATE`
- Approve/Post: `INVENTORY_ADJUST_APPROVE`

### 4.3 Reglas del workflow (cerradas)
- DRAFT: se puede editar líneas.
- SUBMITTED: no se editan líneas (solo approve/reject por RFC si hace falta).
- APPROVED: solo post.
- POSTED: inmutable.
- CANCELED: opcional; si se implementa, RFC primero (para no inventar).

---

## 5) Posting (lógica cerrada)
En `POST /post`:
1) Cargar adjustment + lines.
2) Validar status = APPROVED.
3) Para cada línea:
   - calcular nuevo stock = actual + delta
   - si nuevo stock < 0 => rechazar TODO (atomic) con error claro.
4) Aplicar updates a `inventory_stocks`:
   - UPSERT row si no existe (pero si delta es negativo y row no existe => rechazar por negativo).
5) Insertar ledger row en `inventory_movements` por cada línea:
   - `movement_type=ADJUSTMENT_POSTED`
   - `reference_type=INVENTORY_ADJUSTMENT`
   - `reference_id=adjustment.id`
6) Registrar auditoría (obligatorio):
   - `INVENTORY_ADJUSTMENT_CREATED`
   - `INVENTORY_ADJUSTMENT_SUBMITTED`
   - `INVENTORY_ADJUSTMENT_APPROVED`
   - `INVENTORY_ADJUSTMENT_POSTED`
   - En POSTED registrar before/after por item (si es mucho, al menos summary + metadata con deltas).

---

## 6) Migración DB
Crear migración:
- `backend/src/main/resources/db/migration/V__inventory_adjustments.sql`

Debe:
- crear tablas/constraints
- insertar permisos `INVENTORY_ADJUST_CREATE`, `INVENTORY_ADJUST_APPROVE` idempotente
- mapear permisos a roles base idempotente

---

## 7) Criterios de aceptación (AC) — Gate
- [ ] Se puede crear ajuste DRAFT con motivo.
- [ ] Se pueden agregar líneas en DRAFT.
- [ ] SUBMITTED bloquea edición de líneas.
- [ ] APPROVE requiere permiso.
- [ ] POST aplica stock y crea ledger.
- [ ] POST rechaza si provocaría stock negativo (atomic).
- [ ] Auditoría registra eventos de workflow.
- [ ] UI mínima en español operable.
- [ ] Smoke script sprint14 existe y permite validar end-to-end.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION, sin DONE/APROBADO).
- [ ] Repo compila.

---

## 8) Smoke test manual (usuario) — Gate
### Pasos
1) Backend arriba.
2) Ejecutar:
   - `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint14.ps1`
3) Verificar en DB (comandos a dejar en LOG.md, no inventar outputs):
   - `select * from inventory_stocks where ...;`
   - `select movement_type, delta_quantity_base from inventory_movements order by created_at desc limit 20;`

### Evidencia (LOG.md)
- Output completo del script
- Queries DB

---

## 9) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
