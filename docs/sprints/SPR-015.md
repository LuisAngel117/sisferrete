# SPR-015 — Transferencias entre bodegas/sucursales: IN_TRANSIT + recepción parcial + NO negativo
**Estado:** BLOQUEADO (no editar; cambios solo por RFC/ADR/CHANGELOG)  
**Stage:** 1 (Core local)  
**Duración objetivo:** 45–90 min  
**Tipo:** Inventario (operación)

---

## 1) Objetivo
Implementar transferencias de inventario entre bodegas (misma sucursal o distinta) con:

- Flujo controlado: DRAFT → SUBMITTED → APPROVED → IN_TRANSIT → RECEIVED (parcial o total).
- Recepción parcial (múltiples recepciones sobre una misma transferencia).
- Ledger de movimientos para salida y entrada (dos eventos).
- Regla dura: **NO permitir inventario negativo** en la bodega origen.
- Auditoría completa de acciones sensibles (quién/qué/cuándo + before/after a nivel resumen).

**Decisiones cerradas**
- Multi-tenant: todas las tablas con `tenant_id`.
- Multi-sucursal: transferencias usan `from_branch_id`, `to_branch_id` + bodegas.
- Stock se lleva en unidad base (`base_uom_id` del producto/variante).
- Cantidades con decimales permitidas según UoM base (`allows_decimals`).
- Sin override para negativo: siempre bloquear al aprobar/postear salida si falta stock.

---

## 2) Alcance

### 2.1 INCLUYE (Scope = Sí)

**Permisos (códigos exactos)**
- `INVENTORY_TRANSFER_CREATE`
- `INVENTORY_TRANSFER_APPROVE`
- `INVENTORY_TRANSFER_RECEIVE`
- Reusar: `INVENTORY_VIEW`, `INVENTORY_MANAGE`

Asignación mínima (idempotente):
- `ADMIN`: CREATE + APPROVE + RECEIVE
- `BODEGUERO` (si existe): CREATE + RECEIVE (sin APPROVE)
- `SUPERADMIN`: todos

**DB**
- `inventory_transfers` (header)
- `inventory_transfer_lines`
- `inventory_transfer_receipts` (header de recepción parcial)
- `inventory_transfer_receipt_lines`
- Reusar:
  - `inventory_stocks`
  - `inventory_movements` (ledger)

**Backend**
- CRUD y workflow de transferencias:
  - crear transferencia DRAFT
  - agregar/editar líneas
  - submit
  - approve + dispatch (pasar a IN_TRANSIT) con validación no-negativo y posting de salida
  - recepcionar parcial (crear receipt) y posting de entrada por lo recibido

**Frontend (mínimo, ES)**
- Inventario → Transferencias:
  - lista (filtros por status)
  - crear (origen/destino + líneas)
  - aprobar/enviar (según permisos)
  - recepcionar parcial (según permisos)

**Smoke (obligatorio recomendado)**
- `scripts/smoke/sprint15.ps1`:
  1) login admin
  2) asegurar stock en origen (si está 0, crear por ajuste SPR-014; si falta, RFC)
  3) crear transferencia con una línea
  4) aprobar/enviar (IN_TRANSIT) => salida ledger + stock decremento
  5) recepcionar parcial => entrada ledger + stock incremento en destino
  6) intentar aprobar/enviar con cantidad > stock => debe fallar (409/400) sin cambios

### 2.2 EXCLUYE (Scope = No)
- Reservas e-commerce.
- Transferencias con costos/fletes prorrateados (eso puede ir por RFC).
- Documentos fiscales.

---

## 3) Dependencias/Precondiciones (si falta, RFC)
- Debe existir branch/sucursal + scoping `X-Branch-Id` o mecanismo equivalente.
- Debe existir inventario base (SPR-013) y ajustes (SPR-014) para preparar stock.
Si falta algo: RFC y detener si bloquea.

---

## 4) Modelo de datos (cerrado)

### 4.1 inventory_transfers
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `from_branch_id uuid not null`
- `to_branch_id uuid not null`
- `from_warehouse_id uuid not null`
- `to_warehouse_id uuid not null`
- `status text not null` (DRAFT | SUBMITTED | APPROVED | IN_TRANSIT | PARTIALLY_RECEIVED | RECEIVED | CANCELED)
- `reason text null`
- `created_by_user_id uuid null`
- `approved_by_user_id uuid null`
- `dispatched_by_user_id uuid null`
- `created_at timestamptz not null default now()`
- `approved_at timestamptz null`
- `dispatched_at timestamptz null`
- `received_at timestamptz null` (cuando finaliza total)

Reglas:
- `from_warehouse_id` y `to_warehouse_id` pueden ser distintos branch.
- `status` solo avanza (no retroceder).

### 4.2 inventory_transfer_lines
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `transfer_id uuid not null`
- `product_id uuid not null`
- `variant_id uuid null`
- `base_uom_id uuid not null`
- `quantity_base numeric(18,6) not null`
- `note text null`

Constraints:
- unique `(tenant_id, transfer_id, product_id, variant_id)`
- check `quantity_base > 0`

### 4.3 inventory_transfer_receipts (recepción parcial)
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `transfer_id uuid not null`
- `status text not null` (DRAFT | POSTED)
- `received_by_user_id uuid null`
- `received_at timestamptz null`
- `note text null`
- timestamps

### 4.4 inventory_transfer_receipt_lines
Campos:
- `id uuid pk`
- `tenant_id uuid not null`
- `receipt_id uuid not null`
- `transfer_line_id uuid not null`
- `quantity_received_base numeric(18,6) not null`

Constraints:
- check `quantity_received_base > 0`

**Regla de integridad (aplicación)**
- Suma de recibos por línea <= quantity_base de la línea.

---

## 5) Ledger y posting (cerrado)

### 5.1 Dispatch (paso a IN_TRANSIT)
Acción: `POST /dispatch` (o `approve-and-dispatch`)

- Validar status = SUBMITTED (o APPROVED si separan acciones; definido en API).
- Validar permisos `INVENTORY_TRANSFER_APPROVE`.
- Validar stock suficiente en origen (por cada línea):
  - `inventory_stocks.quantity_base - quantity_base >= 0`
  - si falla: rechazar total (atomic), sin efectos
- Aplicar decrementos a `inventory_stocks` (origen)
- Insertar ledger por línea:
  - `movement_type=TRANSFER_DISPATCHED`
  - `reference_type=INVENTORY_TRANSFER`
  - `reference_id=transfer.id`
  - `delta_quantity_base = -quantity_base`

### 5.2 Receive parcial (POST receipt)
Acción: `POST /receipts`

- Validar transferencia en IN_TRANSIT o PARTIALLY_RECEIVED
- Validar permiso `INVENTORY_TRANSFER_RECEIVE`
- Validar que no se excede lo pendiente
- Aplicar incrementos a stock destino
- Insertar ledger:
  - `movement_type=TRANSFER_RECEIVED`
  - `delta_quantity_base = +quantity_received_base`
- Actualizar status:
  - si recibido total: RECEIVED
  - si parcial: PARTIALLY_RECEIVED

---

## 6) API (cerrada)

### 6.1 Endpoints
Branch scoping:
- `X-Branch-Id` será la “vista actual” del usuario.  
Regla:
- Para crear/gestionar transfer desde branch actual, `X-Branch-Id` debe ser `from_branch_id`.  
Recepción: `X-Branch-Id` debe ser `to_branch_id`.

**Transferencias**
- `GET /api/inventory/transfers?status=...&limit=...`
- `POST /api/inventory/transfers`
- `GET /api/inventory/transfers/{id}`
- `POST /api/inventory/transfers/{id}/lines`
- `PUT /api/inventory/transfer-lines/{lineId}`
- `DELETE /api/inventory/transfer-lines/{lineId}` (solo DRAFT)

**Workflow**
- `POST /api/inventory/transfers/{id}/submit`
- `POST /api/inventory/transfers/{id}/dispatch`  (approve+dispatch)
- `POST /api/inventory/transfers/{id}/receipts` (crea receipt DRAFT con líneas)
- `POST /api/inventory/receipts/{receiptId}/post`

---

## 7) Migración DB
Crear migración:
- `backend/src/main/resources/db/migration/V__inventory_transfers.sql`

Debe:
- crear tablas/constraints/índices
- insertar permisos y mapear a roles base idempotente
- ampliar enum/validaciones si se usan check constraints por status (si no, validar en app)

---

## 8) Criterios de aceptación (AC)
- [ ] Se crea transferencia DRAFT con líneas.
- [ ] Submit bloquea edición (salvo RFC).
- [ ] Dispatch valida stock y no permite negativo (atomic).
- [ ] Dispatch genera ledger de salida.
- [ ] Recepción parcial permite múltiples receipts hasta completar.
- [ ] Recepción genera ledger de entrada.
- [ ] Status PARTIALLY_RECEIVED / RECEIVED correcto.
- [ ] Permisos aplican (403 si corresponde).
- [ ] UI mínima en español operable.
- [ ] Smoke script sprint15 existe.
- [ ] LOG/STATUS listos (READY_FOR_VALIDATION).
- [ ] Repo compila.

---

## 9) Smoke test manual (usuario)
Ejecutar:
- `pwsh -ExecutionPolicy Bypass -File .\scripts\smoke\sprint15.ps1`
Evidencia: output completo en LOG.md.

---

## 10) DoD
- AC completos.
- Estado: READY_FOR_VALIDATION.

<!-- EOF -->
